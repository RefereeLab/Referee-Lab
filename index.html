<!DOCTYPE html>
<html lang="it" class="dark">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PYY47HJGR6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-PYY47HJGR6');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RefereeLab - Analytics Pro</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: { 850: '#151e2e', 900: '#0f172a', 950: '#020617' },
                        brand: { gold: '#EAB308' }
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.3)',
                        'neon': '0 0 10px rgba(234, 179, 8, 0.5)',
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                        'bounce-slight': 'bounceSlight 2s infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        bounceSlight: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* FIX: Prevent horizontal overflow */
        html, body { overflow-x: hidden; }

        body {
            background-color: #020617;
            background-image:
                radial-gradient(circle at 15% 0%, rgba(30, 41, 59, 0.4) 0%, transparent 40%),
                radial-gradient(circle at 85% 0%, rgba(49, 46, 129, 0.2) 0%, transparent 40%),
                linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.4) 100%);
            background-attachment: fixed;
            color: #e2e8f0;
        }

        /* Enhanced Glassmorphism */
        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .glass-header {
            background: rgba(2, 6, 23, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #EAB308; }

        /* Typography */
        .tabular-nums { font-variant-numeric: tabular-nums; }

        /* UI Elements */
        .season-btn { transition: all 0.2s; border: 1px solid transparent; }
        .season-btn:not(.disabled):hover { background: rgba(255, 255, 255, 0.05); transform: translateX(2px); }
        .season-btn.active { 
            background: linear-gradient(90deg, rgba(234, 179, 8, 0.15) 0%, transparent 100%); 
            border-left: 3px solid #EAB308; 
            color: #fbbf24; 
        }
        .season-btn.disabled { opacity: 0.5; cursor: not-allowed; }

        /* Navigation Buttons Style */
        .nav-switcher-btn {
            border: 1px solid transparent;
            color: #94a3b8;
            transition: all 0.2s ease;
        }
        .nav-switcher-btn:hover { color: #fff; }
        .nav-switcher-btn.active {
            background-color: #EAB308;
            color: #000;
            font-weight: 700;
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.4);
            border-color: #EAB308;
        }

        /* FIX #1 & #2: Container for Nav Buttons - Flex on desktop to hug content */
        .nav-buttons-container {
            border: 1px solid rgba(234, 179, 8, 0.5); /* Contorno giallo */
            background-color: rgba(15, 23, 42, 0.8); /* Sfondo semi-trasparente */
            box-shadow: 0 0 10px rgba(234, 179, 8, 0.2);
        }

        /* Range Slider Styling */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 16px; width: 16px; 
            border-radius: 50%; background: #EAB308; cursor: pointer; margin-top: -6px; 
            box-shadow: 0 0 0 2px rgba(2, 6, 23, 1), 0 0 10px rgba(234, 179, 8, 0.5);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }

        .toggle-checkbox:checked { right: 0; border-color: #EAB308; }
        .toggle-checkbox:checked + .toggle-label { background-color: rgba(234, 179, 8, 0.8); }

        /* Table Enhancements */
        #mainTable tr { transition: background-color 0.15s ease; }
        #mainTable tbody tr:hover { background-color: rgba(255,255,255,0.05); }
        
        /* Sticky Columns */
        .sticky-col-head { position: sticky; left: 0; z-index: 30; background-color: #0f172a; box-shadow: 4px 0 8px -2px rgba(0,0,0,0.5); }
        .sticky-col-body {
            position: sticky; left: 0; z-index: 20;
            background-color: #020617; 
            border-right: 1px solid rgba(255,255,255,0.08);
            box-shadow: 4px 0 8px -2px rgba(0,0,0,0.2);
        }
        tr:hover .sticky-col-body { background-color: #1e293b; }

        /* Accordion & Mobile */
        .details-row { display: none; background: rgba(0,0,0,0.3) !important; }
        .details-row.open { display: table-row; animation: fadeIn 0.3s ease; }
        .season-dropdown-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; }
        .season-dropdown-content.open { max-height: 500px; }
        #designations-modal { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateX(100%); }
        #designations-modal.open { transform: translateX(0); }

        /* KPI Cards */
        .kpi-card { background: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.005) 100%); border: 1px solid rgba(255,255,255,0.05); }
        
        /* Bar Graph in Table */
        .mini-bar-bg { background: rgba(255,255,255,0.1); height: 3px; width: 100%; border-radius: 2px; overflow: hidden; margin-top: 4px; }
        .mini-bar-fill { height: 100%; border-radius: 2px; }
        
        /* Bar Graph for Fouls (Red/Orange) */
        .mini-bar-fill.danger { background: #ef4444; }
        
        /* Scroll to Top Button */
        #scroll-to-top { 
            opacity: 0; pointer-events: none; transition: all 0.3s ease; transform: translateY(20px); 
        }
        #scroll-to-top.visible { 
            opacity: 1; pointer-events: auto; transform: translateY(0); 
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse-light { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-light { animation: pulse-light 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="font-sans antialiased min-h-screen flex flex-col selection:bg-yellow-500/30 selection:text-yellow-200 text-slate-300">

    <!-- Scroll To Top Button -->
    <button id="scroll-to-top" onclick="scrollToTop()" class="fixed bottom-6 right-6 z-50 w-12 h-12 rounded-full bg-yellow-500 text-slate-900 shadow-lg flex items-center justify-center hover:bg-yellow-400 hover:scale-110 transition-all border-2 border-slate-900/50">
        <i class="fa-solid fa-arrow-up font-bold"></i>
    </button>

    <!-- Designations Modal (Mobile only) -->
    <div id="designations-modal" class="fixed inset-0 z-[60] bg-slate-950/95 backdrop-blur-xl lg:hidden">
        <div class="h-16 flex items-center px-4 border-b border-white/10 bg-slate-900/80">
            <button onclick="toggleDesignationsModal(false)" class="text-slate-400 hover:text-white transition-colors flex items-center gap-2 text-sm font-bold uppercase tracking-wider">
                <i class="fa-solid fa-arrow-left"></i> <span class="hidden sm:inline">Torna</span>
            </button>
            <h2 class="ml-auto text-white font-bold text-lg tracking-wide flex items-center gap-2">
                <i class="fa-regular fa-calendar-check text-yellow-500"></i> DESIGNAZIONI
            </h2>
        </div>
        <div class="p-4 overflow-y-auto h-[calc(100vh-4rem)]">
            <div id="designations-content" class="space-y-6"> <!-- Gap aumentato per richiesta 11 -->
                <div class="glass-panel rounded-xl p-3 border border-white/30">
                    <div class="pb-2 border-b border-white/30 mb-4 flex flex-col">
                        <h3 class="text-white font-bold text-lg tracking-wide mb-1">PROSSIMA GIORNATA <span class="bg-red-600/20 text-red-400 text-[10px] px-2 py-0.5 rounded ml-2 border border-red-500/30">LIVE</span></h3>
                        <span class="text-yellow-500 font-mono text-base font-bold uppercase tracking-wider">13ª Giornata</span>
                    </div>
                    <!-- Mock Content -->
                    <!-- FIX #7: Diminuzione gap a 2 -->
                    <div class="flex flex-col gap-y-2 text-xs"> 
                        <div class="match-card overflow-hidden rounded-xl hover:bg-white/5 transition-colors border border-green-500/20">
                            <div class="text-slate-900 font-bold bg-green-500/90 text-center py-1 tracking-wider">MILAN - JUVENTUS</div>
                            <div class="p-3 bg-gradient-to-b from-transparent to-black/20">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-slate-400">Arbitro</span>
                                    <span class="text-white font-bold text-sm">CHIFFI</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-slate-500">VAR</span>
                                    <span class="text-violet-300 font-mono">MAZZOLENI</span>
                                </div>
                            </div>
                        </div>
                        <div class="match-card overflow-hidden rounded-xl hover:bg-white/5 transition-colors border border-slate-700/50">
                            <div class="text-slate-200 font-bold bg-slate-800/50 text-center py-1 tracking-wider">ROMA - NAPOLI</div>
                            <div class="p-3 bg-gradient-to-b from-transparent to-black/20">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-slate-400">Arbitro</span>
                                    <span class="text-white font-bold text-sm">MASSA</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-slate-500">VAR</span>
                                    <span class="text-violet-300 font-mono">ABISSO</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-slate-500 text-center text-xs mt-4 p-4 border border-dashed border-slate-700 rounded-lg">
                            <i class="fa-solid fa-database mb-2"></i><br>
                            Dati completi in arrivo...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="glass-header sticky top-0 z-50 transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3 cursor-pointer group" onclick="window.location.reload()">
                    <div class="relative">
                        <div class="hidden sm:flex w-8 h-8 rounded-lg bg-gradient-to-br from-yellow-400 to-yellow-600 items-center justify-center text-slate-900 shadow-neon group-hover:scale-110 transition-transform duration-300">
                            <i class="fa-solid fa-whistle rotate-[-20deg] text-sm"></i>
                        </div>
                        <div class="absolute -bottom-1 -right-1 w-2.5 h-2.5 bg-green-500 rounded-full border-2 border-slate-900 hidden sm:block"></div>
                    </div>
                    <div class="flex flex-col">
                        <span class="font-bold text-lg tracking-tight text-white leading-none group-hover:text-yellow-400 transition-colors">Referee<span class="text-yellow-500">Lab</span></span>
                        <span class="text-[10px] uppercase tracking-[0.2em] text-slate-500 font-semibold group-hover:text-slate-400">Pro Analytics</span>
                    </div>
                </div>

                <!-- Nav buttons: NEW SPLIT STRUCTURE -->
                <div class="flex items-center gap-3 w-full sm:w-auto mx-2 sm:mx-8">
                    
                    <!-- Main Group (Stats, Tempo, Partite) - Yellow Border Container -->
                    <div class="grid grid-cols-3 sm:flex gap-1 flex-grow sm:flex-grow-0 nav-buttons-container rounded-full p-1 border-yellow-500 border w-full sm:w-auto">
                        <button onclick="switchView('stats')" id="nav-stats" class="nav-switcher-btn active justify-center px-1 sm:px-5 py-1.5 rounded-full text-[10px] sm:text-xs uppercase tracking-wider flex items-center gap-1 sm:gap-2 bg-transparent shadow-none">
                            <i class="fa-solid fa-chart-simple"></i> <span class="hidden sm:inline font-semibold">Stats</span> <span class="inline sm:hidden">Stats</span>
                        </button>
                        <button onclick="switchView('playingTime')" id="nav-time" class="nav-switcher-btn justify-center px-1 sm:px-5 py-1.5 rounded-full text-[10px] sm:text-xs uppercase tracking-wider flex items-center gap-1 sm:gap-2 bg-transparent shadow-none">
                            <i class="fa-solid fa-stopwatch"></i> <span class="hidden sm:inline font-semibold">Tempo</span> <span class="inline sm:hidden">Tempo</span>
                        </button>
                        <button onclick="switchView('matches')" id="nav-matches" class="nav-switcher-btn justify-center px-1 sm:px-5 py-1.5 rounded-full text-[10px] sm:text-xs uppercase tracking-wider flex items-center gap-1 sm:gap-2 bg-transparent shadow-none">
                            <i class="fa-solid fa-futbol"></i> <span class="hidden sm:inline font-semibold">Partite</span> <span class="inline sm:hidden">Part.</span>
                        </button>
                    </div>

                    <!-- Separated Designations Button (Mobile Only) - Distinct Style -->
                    <button onclick="toggleDesignationsModal(true)" id="nav-designations-mobile" class="lg:hidden flex-none w-10 h-10 rounded-full bg-slate-800 border border-slate-700 text-yellow-500 flex items-center justify-center hover:bg-slate-700 hover:text-yellow-400 hover:border-yellow-500/50 transition-all shadow-lg active:scale-95">
                        <i class="fa-regular fa-calendar-check text-base"></i>
                    </button>

                </div>

                <div class="hidden sm:flex items-center gap-4">
                    <button class="text-slate-400 hover:text-white transition-colors" title="Esporta Dati" onclick="alert('Export functionality coming soon!')">
                        <i class="fa-solid fa-download"></i>
                    </button>
                    <div class="h-4 w-px bg-white/10"></div>
                    <a href="https://instagram.com/reflab25" target="_blank" class="text-slate-400 hover:text-pink-500 transition-colors transform hover:scale-110 duration-200">
                        <i class="fa-brands fa-instagram text-xl"></i>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content-wrapper" class="flex-grow max-w-7xl mx-auto px-2 sm:px-6 lg:px-8 py-6 w-full">

        <div class="grid grid-cols-1 lg:grid-cols-6 gap-6 mb-6">

            <!-- Controls (Left Sidebar) -->
            <div class="lg:col-span-1 space-y-4 sm:space-y-6">
                <div class="glass-panel rounded-xl p-4 sm:p-5 space-y-5">
                    <!-- Search -->
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 block">Ricerca</label>
                        <div class="group flex items-center w-full bg-slate-950/50 border border-slate-700/50 rounded-lg focus-within:border-yellow-500/50 focus-within:shadow-neon transition-all overflow-hidden">
                            <div class="pl-3 py-2 text-slate-500 group-focus-within:text-yellow-500 transition-colors">
                                <i class="fa-solid fa-magnifying-glass"></i>
                            </div>
                            <!-- FIX #5: Placeholder gestito da JS -->
                            <input type="text" id="searchInput" oninput="handleSearch()" placeholder="Arbitro..." class="w-full bg-transparent border-none text-white text-xs sm:text-sm p-2.5 focus:ring-0 outline-none placeholder-slate-600">
                        </div>
                    </div>

                    <!-- Season Accordion -->
                    <div id="season-accordion-wrapper" class="border-t border-white/5 pt-4">
                        <button onclick="toggleSeasonDropdown()" class="w-full flex justify-between items-center py-2 px-1 hover:bg-white/5 rounded-lg transition-colors lg:cursor-default lg:pointer-events-none group">
                            <div class="flex items-center gap-2">
                                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest cursor-pointer group-hover:text-slate-300 transition-colors">Stagione</label>
                                <i id="season-toggle-icon" class="fa-solid fa-chevron-down text-xs text-slate-500 lg:hidden transition-transform duration-300"></i>
                            </div>
                            <button onclick="toggleAllSeasons()" class="hidden lg:block text-[9px] bg-yellow-500/10 hover:bg-yellow-500/20 text-yellow-500 px-2 py-1 rounded uppercase font-bold tracking-wider transition-colors">Tutte</button>
                        </button>
                        
                        <div id="season-dropdown-content" class="season-dropdown-content lg:max-h-none lg:overflow-visible lg:mt-2 lg:pt-0 open">
                            <div class="flex justify-end lg:hidden mb-2">
                                <button onclick="toggleAllSeasons()" class="text-[10px] text-yellow-500 hover:text-white uppercase font-bold tracking-wider bg-yellow-500/10 px-2 py-1 rounded">Seleziona Tutte</button>
                            </div>

                            <div class="grid grid-cols-2 lg:grid-cols-1 gap-1.5" id="season-buttons">
                                <button onclick="toggleSeason('2025-26')" id="btn-2025-26" class="season-btn active px-3 py-2.5 rounded-lg text-xs font-medium text-slate-400 w-full text-left flex justify-between items-center shadow-sm" data-season="2025-26">
                                    <span class="font-mono">2025/26</span> <i class="fa-solid fa-check text-xs opacity-0 check-icon text-yellow-500"></i>
                                </button>
                                <button onclick="toggleSeason('2024-25')" id="btn-2024-25" class="season-btn px-3 py-2.5 rounded-lg text-xs font-medium text-slate-400 w-full text-left flex justify-between items-center shadow-sm" data-season="2024-25">
                                    <span class="font-mono">2024/25</span> <i class="fa-solid fa-check text-xs opacity-0 check-icon text-yellow-500"></i>
                                </button>
                                
                                <!-- Historic Seasons -->
                                <button onclick="toggleSeason('2023-24')" id="btn-2023-24" class="season-btn px-3 py-2.5 rounded-lg text-xs font-medium text-slate-400 w-full text-left flex justify-between items-center shadow-sm" data-season="2023-24">
                                    <span class="font-mono">2023/24</span> 
                                    <div class="flex items-center gap-2">
                                        <span class="text-[9px] uppercase font-bold text-slate-600 coming-soon-label hidden">PRESTO</span>
                                        <i class="fa-solid fa-check text-xs opacity-0 check-icon text-yellow-500"></i>
                                    </div>
                                </button>
                                <button onclick="toggleSeason('2022-23')" id="btn-2022-23" class="season-btn px-3 py-2.5 rounded-lg text-xs font-medium text-slate-400 w-full text-left flex justify-between items-center shadow-sm" data-season="2022-23">
                                    <span class="font-mono">2022/23</span> 
                                    <div class="flex items-center gap-2">
                                        <span class="text-[9px] uppercase font-bold text-slate-600 coming-soon-label hidden">PRESTO</span>
                                        <i class="fa-solid fa-check text-xs opacity-0 check-icon text-yellow-500"></i>
                                    </div>
                                </button>
                                <button onclick="toggleSeason('2021-22')" id="btn-2021-22" class="season-btn px-3 py-2.5 rounded-lg text-xs font-medium text-slate-400 w-full text-left flex justify-between items-center shadow-sm" data-season="2021-22">
                                    <span class="font-mono">2021/22</span> 
                                    <div class="flex items-center gap-2">
                                        <span class="text-[9px] uppercase font-bold text-slate-600 coming-soon-label hidden">PRESTO</span>
                                        <i class="fa-solid fa-check text-xs opacity-0 check-icon text-yellow-500"></i>
                                    </div>
                                </button>
                                <button onclick="toggleSeason('2020-21')" id="btn-2020-21" class="season-btn px-3 py-2.5 rounded-lg text-xs font-medium text-slate-400 w-full text-left flex justify-between items-center shadow-sm" data-season="2020-21">
                                    <span class="font-mono">2020/21</span> 
                                    <div class="flex items-center gap-2">
                                        <span class="text-[9px] uppercase font-bold text-slate-600 coming-soon-label hidden">PRESTO</span>
                                        <i class="fa-solid fa-check text-xs opacity-0 check-icon text-yellow-500"></i>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="stats-controls" class="space-y-4 pt-2 border-t border-white/5">
                        <div class="flex items-center justify-between py-1">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Nascondi Inattivi</label>
                            <div class="relative inline-block w-9 h-5 align-middle select-none">
                                <input type="checkbox" name="toggle" id="toggleInactive" onclick="toggleInactiveRefs()" class="toggle-checkbox absolute block w-3 h-3 m-1 rounded-full bg-white appearance-none cursor-pointer transition-all duration-300 left-0 top-0 z-10"/>
                                <label for="toggleInactive" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-700 cursor-pointer border border-slate-600 transition-colors"></label>
                            </div>
                        </div>

                        <div class="bg-slate-950/30 p-3 rounded-lg border border-white/5">
                            <div class="hidden lg:flex justify-between items-center mb-3">
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Min. Presenze</span>
                                <span id="minMatchesValue" class="text-yellow-500 font-mono font-medium text-sm bg-yellow-500/10 px-2 rounded">0</span>
                            </div>
                            <input type="range" id="minMatches" min="0" max="10" value="0" step="1" oninput="updateMinMatches(this.value)" class="hidden lg:block w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                            
                            <!-- Mobile Compact Slider -->
                            <div class="flex items-center justify-between gap-3 lg:hidden">
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest flex-shrink-0">Min. Presenze</span>
                                <input type="range" id="minMatches_mobile" min="0" max="10" value="0" step="1" oninput="updateMinMatches(this.value)" class="flex-grow h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                <span id="minMatchesValue_mobile" class="text-yellow-500 font-mono font-medium text-sm w-4 text-right flex-shrink-0">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Insights / Filters Info Container - FIX #3: Removed specific insights, kept for future use if needed -->
                <div id="insights-container" class="flex flex-col gap-3 hidden sm:flex animate-fade-in-up"></div>
            </div>

            <!-- Main Data Table Column -->
            <div id="main-content-col" class="lg:col-span-4 flex flex-col gap-6">
                
                <!-- NEW: KPI Cards Row (Dynamic Summary) - FIX #3 (Hidden on mobile) -->
                <div id="kpi-dashboard" class="hidden md:grid grid-cols-4 gap-4 mb-2">
                    <div class="glass-panel p-3 rounded-xl kpi-card flex flex-col items-center justify-center text-center">
                        <span id="kpi-label-1" class="text-[9px] uppercase tracking-widest text-slate-500 font-bold">Arbitri Tot.</span>
                        <span id="kpi-value-1" class="text-2xl font-mono text-white font-bold mt-1">-</span>
                    </div>
                    <div class="glass-panel p-3 rounded-xl kpi-card flex flex-col items-center justify-center text-center">
                        <span id="kpi-label-2" class="text-[9px] uppercase tracking-widest text-slate-500 font-bold">Media Falli</span>
                        <span id="kpi-value-2" class="text-2xl font-mono text-yellow-400 font-bold mt-1">-</span>
                    </div>
                    <div class="glass-panel p-3 rounded-xl kpi-card flex flex-col items-center justify-center text-center">
                        <span id="kpi-label-3" class="text-[9px] uppercase tracking-widest text-slate-500 font-bold">Media T.E.</span>
                        <span id="kpi-value-3" class="text-2xl font-mono text-green-400 font-bold mt-1">-</span>
                    </div>
                    <div class="glass-panel p-3 rounded-xl kpi-card flex flex-col items-center justify-center text-center">
                        <span id="kpi-label-4" class="text-[9px] uppercase tracking-widest text-slate-500 font-bold">Rigori Tot.</span>
                        <span id="kpi-value-4" class="text-2xl font-mono text-blue-400 font-bold mt-1">-</span>
                    </div>
                </div>

                <div class="glass-panel rounded-xl overflow-hidden shadow-glass relative min-h-[500px] flex flex-col border border-white/10">

                    <!-- Dynamic Header Titles -->
                    <div id="playing-time-title" class="hidden w-full relative py-5 border-b border-white/5 bg-gradient-to-r from-slate-900/50 via-slate-800/50 to-slate-900/50 flex items-center justify-center backdrop-blur-sm flex-col">
                         <div class="w-full flex items-center justify-center relative px-4">
                             <button onclick="switchView('stats')" class="absolute left-4 text-slate-400 hover:text-white transition-colors flex items-center gap-2 text-xs font-bold uppercase tracking-wider px-3 py-1.5 rounded-lg border border-transparent hover:border-white/10 hover:bg-white/5">
                                 <i class="fa-solid fa-arrow-left"></i> <span class="hidden sm:inline">Stats</span>
                             </button>
                             <div class="text-center">
                                <h2 class="text-lg sm:text-2xl font-bold text-white tracking-tight">Tempo <span class="text-green-400 font-light">Effettivo</span></h2>
                                <p class="text-slate-500 text-[10px] uppercase tracking-[0.2em] mt-1 font-bold">Analisi Minutaggio</p>
                            </div>
                             <button onclick="switchView('matches')" class="absolute right-4 text-slate-400 hover:text-white transition-colors flex items-center gap-2 text-xs font-bold uppercase tracking-wider px-3 py-1.5 rounded-lg border border-transparent hover:border-white/10 hover:bg-white/5">
                                 <span class="hidden sm:inline">Partite</span> <i class="fa-solid fa-arrow-right"></i>
                             </button>
                         </div>
                    </div>

                    <div id="matches-title" class="hidden w-full relative py-5 border-b border-white/5 bg-gradient-to-r from-slate-900/50 via-slate-800/50 to-slate-900/50 flex items-center justify-center backdrop-blur-sm flex-col">
                        <div class="w-full flex items-center justify-center relative px-4">
                            <button onclick="switchView('playingTime')" class="absolute left-4 text-slate-400 hover:text-white transition-colors flex items-center gap-2 text-xs font-bold uppercase tracking-wider px-3 py-1.5 rounded-lg border border-transparent hover:border-white/10 hover:bg-white/5">
                                 <i class="fa-solid fa-arrow-left"></i> <span class="hidden sm:inline">T. Eff</span>
                             </button>
                             <div class="text-center">
                                <h2 class="text-lg sm:text-2xl font-bold text-white tracking-tight">Elenco <span class="text-blue-400 font-light">Partite</span></h2>
                                <p class="text-slate-500 text-[10px] uppercase tracking-[0.2em] mt-1 font-bold">Database Completo</p>
                            </div>
                        </div>
                    </div>

                    <!-- Alert Banner -->
                    <div id="update-alert-2526" class="hidden w-full bg-blue-500/5 border-b border-blue-500/10 p-2 text-center flex items-center justify-center gap-2">
                         <div class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-pulse"></div>
                        <p class="text-[10px] sm:text-xs text-blue-200 font-mono tracking-wide">Dati aggiornati alla 12ª giornata</p>
                    </div>

                    <!-- Main Table -->
                    <div class="overflow-x-auto flex-grow scrollbar-hide relative">
                        <table class="w-full text-left text-slate-300" id="mainTable">
                            <thead class="text-[10px] sm:text-xs text-slate-400 uppercase bg-slate-900/95 border-b border-white/5 sticky top-0 z-40 backdrop-blur-xl shadow-lg" id="tableHeader"></thead>
                            <tbody id="tableBody" class="divide-y divide-white/5 font-mono text-[11px] sm:text-xs md:text-sm"></tbody>
                            <tfoot class="bg-slate-900/90 border-t-2 border-white/10 font-bold text-white backdrop-blur-md sticky bottom-0 z-40 shadow-[0_-5px_15px_rgba(0,0,0,0.3)] text-xs sm:text-sm font-extrabold" id="tableFooter"></tfoot>
                        </table>

                        <!-- Empty State -->
                        <div id="empty-state-msg" class="hidden flex flex-col items-center justify-center h-64 text-slate-500">
                            <i class="fa-solid fa-database text-4xl mb-4 opacity-30"></i>
                            <p class="text-xs uppercase tracking-widest font-bold opacity-60">Nessun dato disponibile</p>
                        </div>

                        <!-- Historical Data Loading -->
                        <div id="historical-data-msg" class="hidden flex flex-col items-center justify-center h-80 text-center px-4">
                            <div class="relative mb-8">
                                <i class="fa-solid fa-server text-5xl text-slate-700"></i>
                                <div class="absolute -bottom-2 -right-2 w-4 h-4 bg-yellow-500 rounded-full animate-bounce"></div>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-2 tracking-wide" id="historical-msg-title">Recupero Dati in Corso</h3>
                            <p class="text-sm text-slate-400 max-w-sm leading-relaxed">Stiamo elaborando i dati storici per le stagioni selezionate.</p>
                        </div>
                    </div>

                    <!-- FIX #5: Eliminazione Legenda -->
                    <!-- Rimosso blocco Legenda/Footer Info -->
                </div>

                <!-- Footer MOVED HERE: Inside Main Content Column -->
                <div class="mt-4 border-t border-white/5 pt-6 pb-6 text-center text-slate-600 text-[10px] uppercase tracking-widest bg-slate-950/90 rounded-xl backdrop-blur-sm">
                    <p class="mb-2">RefereeLab Analytics Platform v2.0</p>
                    <p>Dati elaborati da fonti pubbliche. Non affiliato con AIA/FIGC.</p>
                </div>
            </div>

            <!-- Designations (Desktop Only - Enhanced) -->
            <div class="hidden lg:block lg:col-span-1 space-y-6">
                <div class="glass-panel rounded-xl p-3 border border-white/30 sticky top-24">
                    <div class="pb-2 border-b border-white/30 mb-4 flex flex-col">
                        <h3 class="text-white font-bold text-sm tracking-wide mb-1 flex items-center gap-2">
                            <i class="fa-regular fa-calendar-days text-yellow-500"></i> DESIGNAZIONI
                        </h3>
                        <div class="flex justify-between items-end">
                            <span class="text-yellow-500 font-mono text-[14px] font-bold uppercase tracking-wider">13ª Giornata</span>
                            <span class="bg-red-500/20 text-red-400 text-[9px] px-1.5 rounded border border-red-500/30 font-bold animate-pulse">LIVE</span>
                        </div>
                    </div>

                    <div class="flex flex-col gap-y-2 text-xs"> <!-- FIX #7: Riduzione gap-y a 2 -->
                        <div class="match-card overflow-hidden rounded-lg hover:bg-white/5 transition-all border border-l-4 border-slate-700 hover:border-l-green-500 group">
                            <div class="text-slate-200 font-bold bg-slate-800/50 px-2 py-1.5 flex justify-between">
                                <span>MILAN - JUVENTUS</span>
                                <span class="text-slate-500 text-[10px]">SAB 18:00</span>
                            </div>
                            <div class="p-2 space-y-1">
                                <div class="flex items-center justify-between">
                                    <span class="text-slate-400 text-[10px] uppercase">Arb</span>
                                    <span class="text-green-400 font-bold">CHIFFI</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-slate-400 text-[10px] uppercase">Var</span>
                                    <span class="text-slate-300">MAZZOLENI</span>
                                </div>
                            </div>
                        </div>
                         <!-- Dummy Items to fill space -->
                         <div class="p-4 text-center border border-dashed border-slate-700 rounded-lg text-slate-600">
                             <span class="text-[10px] italic">Altre designazioni in caricamento...</span>
                         </div>
                    </div>
                </div>
            </div>
        </div> 
    </main>

    <script>
        // --- DATA SECTION ---
        // (Placeholders kept as requested, imagine full data here)
        const MATCHES_DB_2425 = ``;
        const MATCHES_DB_2526 = ``;
        const EXTRA_MATCHES_2526 = ``;

        const PLAYING_TIME_DB = {
            "2025-26": ``, "2024-25": ``, "2023-24": ``, "2022-23": ``, "2021-22": ``, "2020-21": ``
        };

        const TOTAL_TIME_DB = ``;

        const db = {
            "2025-26": [
                { name: "Luca Zufferli", matches: 7, fouls_avg: 26.71, penalties_ap: 0.57, yellows_ap: 3.00, yellows: 21, reds_ap: 0.00, reds: 0 },
                { name: "Giuseppe Collu", matches: 7, fouls_avg: 23.29, penalties_ap: 0.57, yellows_ap: 4.29, yellows: 30, reds_ap: 0.00, reds: 0 },
            ],
            "2024-25": [
                { name: "Davide Massa", matches: 19, fouls_avg: 25.74, penalties_ap: 0.16, yellows_ap: 4.21, yellows: 80, reds_ap: 0.26, reds: 5 },
                { name: "Maurizio Mariani", matches: 18, fouls_avg: 25.94, penalties_ap: 0.11, yellows_ap: 3.72, yellows: 67, reds_ap: 0.17, reds: 3 },
            ],
            "2023-24": [
                { name: "Marco Guida", matches: 17, fouls_avg: 23.59, penalties_ap: 0.47, yellows_ap: 4.00, yellows: 68, reds_ap: 0.06, reds: 1 },
                { name: "Daniele Doveri", matches: 17, fouls_avg: 24.47, penalties_ap: 0.18, yellows_ap: 3.24, yellows: 55, reds_ap: 0.35, reds: 6 },
            ],
            "2022-23": [ { name: "Daniele Orsato", matches: 15, fouls_avg: 21.40, penalties_ap: 0.00, yellows_ap: 3.00, yellows: 45, reds_ap: 0.07, reds: 1 } ],
            "2021-22": [ { name: "Daniele Doveri", matches: 17, fouls_avg: 26.82, penalties_ap: 0.35, yellows_ap: 3.47, yellows: 59, reds_ap: 0.18, reds: 3 } ],
            "2020-21": [ { name: "Maurizio Mariani", matches: 18, fouls_avg: 27.11, penalties_ap: 0.50, yellows_ap: 3.67, yellows: 66, reds_ap: 0.11, reds: 2 } ],
        };

        const HISTORICAL_SEASONS = ['2023-24', '2022-23', '2021-22', '2020-21'];

        // -----------------------
        // --- LOGIC SECTION ---
        // -----------------------
        let currentView = 'stats';
        let activeSeasons = ['2025-26'];
        let sortColumn = 'matches';
        let sortDirection = 'desc';
        let minMatchesFilter = 0;
        let hideInactive = false;
        let isSeasonDropdownOpen = false;

        const REFEREES_2425 = ["Feliciani", "Ayroldi", "Fabbri", "Maresca", "Caputi", "Marchetti", "Marinelli", "Tremolada", "Massa", "Marcenaro", "Sacchi", "Doveri", "Di Marco", "Mariani", "Rapuano", "Sozza", "Pairetto", "Zufferli", "Di Bello", "Giua", "Colombo", "Guida", "Prontera", "Piccinini", "La Penna", "Abisso", "Aureliano", "Manganiello", "Fourneau", "Chiffi", "Dionisi", "Collu", "Massimi", "Bonacina", "Cosso", "Perenzoni", "Ghersini", "Monaldi", "Rutella"];
        const REFEREES_2526 = ["Massa", "Ayroldi", "Collu", "Zufferli", "Sozza", "Manganiello", "Arena", "Marcenaro", "Tremolada", "La Penna", "Guida", "Marinelli", "Doveri", "Mariani", "Bonacina", "Chiffi", "Abisso", "Marchetti", "Crezzini", "Fourneau", "Colombo", "Piccinini", "Rapuano", "Feliciani", "Fabbri", "Dionisi", "Di Bello", "Pairetto", "Sacchi", "Pezzuto", "Di Marco", "Galipò", "Perenzoni", "Ghersini", "Rutella", "Camplone", "Monaldi", "Cosso", "Santoro", "Scatena"];
        const ACTIVE_EXCEPTIONS = ["Maresca", "Caputi", "Ferrieri Caputi"];
        const HISTORICAL_SURNAMES = ["Irrati", "Orsato", "Valeri", "Pasqua", "Calvarese", "Giacomelli"];

        // --- Parsing Functions (UNCHANGED) ---
        function parseTimeStr(str) {
            if(!str || str.trim().toUpperCase() === 'ND') return NaN;
            const clean = str.replace(/[^\d,\.]/g, '').replace(',', '.');
            const parts = clean.split('.');
            let m = parseInt(parts[0]) || 0;
            let s = parts.length > 1 ? parseInt(parts[1]) : 0;
            return (m * 60) + s;
        }

        function formatSecondsToTime(totalSeconds) {
            if(isNaN(totalSeconds)) return "ND";
            if(!totalSeconds && totalSeconds !== 0) return "00'00''";
            const m = Math.floor(totalSeconds / 60);
            const s = Math.round(totalSeconds % 60);
            return `${m}'${s.toString().padStart(2, '0')}''`;
        }

        function parseItalianFloat(str) {
            if(!str || str.trim().toUpperCase() === 'ND') return NaN;
            return parseFloat(str.replace(',', '.').replace('%', ''));
        }

        function isRefereeActive(name) {
            const searchName = name.toUpperCase();
            if (activeSeasons.includes('2025-26')) {
                 if (REFEREES_2526.some(surname => searchName.includes(surname.toUpperCase()))) return true;
                 if (ACTIVE_EXCEPTIONS.some(ex => searchName.includes(ex.toUpperCase()))) return true;
            }
            if (!activeSeasons.includes('2025-26') && activeSeasons.includes('2024-25')) {
                 if (REFEREES_2425.some(surname => searchName.includes(surname.toUpperCase()))) return true;
            }
            return REFEREES_2526.some(surname => searchName.includes(surname.toUpperCase())) ||
                   ACTIVE_EXCEPTIONS.some(ex => searchName.includes(ex.toUpperCase()));
        }

        function formatRefereeNameHTML(fullName) {
            const upperName = fullName.toUpperCase();
            const allSurnames = [...REFEREES_2526, ...REFEREES_2425, ...ACTIVE_EXCEPTIONS, ...HISTORICAL_SURNAMES];
            const matches = allSurnames.filter(s => {
                const sUp = s.toUpperCase();
                return upperName.endsWith(" " + sUp) || upperName === sUp || upperName.includes(" " + sUp + " ");
            });
            const match = matches.sort((a, b) => b.length - a.length)[0];
            let surname = "", firstname = "";

            if (match) {
                const idx = upperName.lastIndexOf(match.toUpperCase());
                surname = fullName.substring(idx);
                firstname = fullName.substring(0, idx).trim();
            } else {
                const parts = fullName.split(' ');
                surname = parts.pop();
                firstname = parts.join(' ');
            }
            const formattedFirst = firstname.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            
            return `<div class="flex items-center">
                        <span class="font-sans font-normal text-slate-400 capitalize mr-1">${formattedFirst}</span> 
                        <span class="font-sans font-bold text-white uppercase tracking-wide">${surname}</span>
                    </div>`;
        }

        function parseMatchesDB(dbString, season) {
            if(!dbString || dbString.trim() === '') return [];
            return dbString.trim().split('\n').map(line => {
                const p = line.trim().split(/\t+/);
                if (p.length < 5) return null;
                const matchName = p[0].trim();
                const tSec = parseTimeStr(p[1]);
                const eSec = parseTimeStr(p[2]);
                const ratioVal = parseItalianFloat(p[3]);
                const fouls = parseInt(p[4]) || 0;
                const yellows = p.length > 5 ? (parseInt(p[5]) || 0) : 0;
                const reds = p.length > 6 ? (parseInt(p[6]) || 0) : 0;
                const pens = p.length > 7 ? (parseItalianFloat(p[7]) || 0) : 0;
                return {
                    match: matchName, totalTimeSec: tSec, effectiveTimeSec: eSec,
                    fouls: fouls, yellows: yellows, reds: reds, pens: pens,
                    ratio: ratioVal, season: season, rawTotal: p[1], rawEff: p[2]
                };
            }).filter(x => x);
        }

        function parsePlayingTimeDB(dbString, season) {
             if(!dbString || dbString.trim() === '') return [];
             return dbString.trim().split('\n').map(line => {
                 const p = line.split('\t');
                 if (p.length < 2) return null;
                 return {
                     season: season,
                     referee: p[0].trim(),
                     effectiveTimeSec: parseTimeStr(p[1]),
                     totalTimeSec: p.length > 2 ? parseTimeStr(p[2]) : NaN
                 };
             }).filter(x => x);
        }

        // --- Data Processing (UNCHANGED) ---
        function processStatsData() {
            let statsMap = new Map();
            const sourceDB = (typeof db !== 'undefined') ? db : STATS_DB;
            activeSeasons.forEach(season => {
                if (sourceDB[season] && sourceDB[season].length > 0) {
                    sourceDB[season].forEach(m => {
                        if (!statsMap.has(m.name)) {
                            statsMap.set(m.name, {
                                name: m.name, matches: 0, fouls: 0, yellows: 0, reds: 0, pens: 0, isInactive: false,
                                w_avgFouls: 0, w_avgYellows: 0, w_avgReds: 0, w_avgPens: 0
                            });
                        }
                        let r = statsMap.get(m.name);
                        r.matches += m.matches;
                        r.yellows += m.yellows;
                        r.reds += m.reds;
                        r.w_avgFouls += m.fouls_avg * m.matches;
                        r.w_avgYellows += m.yellows_ap * m.matches;
                        r.w_avgReds += m.reds_ap * m.matches;
                        r.w_avgPens += m.penalties_ap * m.matches;
                    });
                }
            });
            return Array.from(statsMap.values()).map(r => {
                r.avgFouls = r.matches ? (r.w_avgFouls / r.matches) : 0;
                r.avgYellows = r.matches ? (r.w_avgYellows / r.matches) : 0;
                r.avgReds = r.matches ? (r.w_avgReds / r.matches) : 0;
                r.avgPens = r.matches ? (r.w_avgPens / r.matches) : 0;
                r.isInactive = !isRefereeActive(r.name);
                return r;
            });
        }

        function processPlayingTimeViewData() {
            let statsMap = new Map();
            let allMatchData = [];
            activeSeasons.forEach(s => {
                let db = (s === '2025-26') ? MATCHES_DB_2526 + EXTRA_MATCHES_2526 : (s === '2024-25' ? MATCHES_DB_2425 : null);
                if(db) allMatchData = allMatchData.concat(parseMatchesDB(db, s));
            });

            activeSeasons.forEach(season => {
                const refData = parsePlayingTimeDB(PLAYING_TIME_DB[season], season);
                const assignedMatches = new Set();
                refData.forEach(entry => {
                    if (!statsMap.has(entry.referee)) {
                        statsMap.set(entry.referee, {
                            name: entry.referee, matches: 0, totalEffectiveSec: 0, totalTotalSec: 0,
                            validEffMatches: 0, validTotMatches: 0, matchList: [], has2526: false
                        });
                    }
                    let r = statsMap.get(entry.referee);
                    r.matches++;
                    if(!isNaN(entry.effectiveTimeSec)) { r.totalEffectiveSec += entry.effectiveTimeSec; r.validEffMatches++; }
                    if(season === '2025-26') r.has2526 = true;

                    let match = null;
                    const unassignedMatchesSeason = allMatchData.filter(m => !assignedMatches.has(m.match) && m.season === season);
                    if (!isNaN(entry.effectiveTimeSec)) match = unassignedMatchesSeason.find(m => Math.abs(m.effectiveTimeSec - entry.effectiveTimeSec) < 1);
                    
                    if (!match && !isNaN(entry.totalTimeSec)) {
                         const candidates = unassignedMatchesSeason.filter(m => Math.abs(m.totalTimeSec - entry.totalTimeSec) < 2);
                         if (candidates.length > 0) match = isNaN(entry.effectiveTimeSec) ? candidates.find(m => isNaN(m.effectiveTimeSec)) : candidates[0];
                    }

                    if(match) {
                         r.matchList.push(match); assignedMatches.add(match.match);
                         if(!isNaN(match.totalTimeSec)) { r.totalTotalSec += match.totalTimeSec; r.validTotMatches++; }
                    } else {
                        let manualTotal = !isNaN(entry.totalTimeSec) ? entry.totalTimeSec : NaN;
                        if(!isNaN(manualTotal)) { r.totalTotalSec += manualTotal; r.validTotMatches++; }
                        r.matchList.push({ match: "Dettaglio non disp.", season: season, effectiveTimeSec: entry.effectiveTimeSec, totalTimeSec: manualTotal, fouls: 0, yellows: 0, reds: 0, pens: 0, ratio: NaN });
                    }
                });
            });
            return Array.from(statsMap.values()).map(r => {
                r.avgEffSec = r.validEffMatches ? (r.totalEffectiveSec / r.validEffMatches) : 0;
                r.avgTotSec = r.validTotMatches ? (r.totalTotalSec / r.validTotMatches) : 0;
                return r;
            });
        }

        function processMatchesViewData() {
            let all = [];
            activeSeasons.forEach(s => {
                let db = (s === '2025-26') ? MATCHES_DB_2526 + EXTRA_MATCHES_2526 : (s === '2024-25' ? MATCHES_DB_2425 : null);
                if(db) all = all.concat(parseMatchesDB(db, s));
            });
            return all;
        }

        function aggregateData() {
            // FIX BUG #2: Reset aggressivo di tutti gli stati di visualizzazione prima di ricalcolare
            const msgHistorical = document.getElementById('historical-data-msg');
            const msgEmpty = document.getElementById('empty-state-msg');
            const table = document.getElementById('mainTable');
            
            if(msgHistorical) msgHistorical.classList.add('hidden');
            if(msgEmpty) msgEmpty.classList.add('hidden');
            if(table) table.classList.add('hidden');

            let result = [];
            
            // Reset UI other elements
            const elementsToReset = [
                'stats-controls', 'playing-time-title', 'matches-title', 'disclaimer-2526', 
                'update-alert-2526'
            ];

            elementsToReset.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.classList.add('hidden');
            });

            // Specific reset for display titles
            const playingTimeTitle = document.getElementById('playing-time-title');
            if (playingTimeTitle) playingTimeTitle.classList.add('hidden');
            const matchesTitle = document.getElementById('matches-title');
            if (matchesTitle) matchesTitle.classList.add('hidden');


            const is2526Active = activeSeasons.includes('2025-26');
            
            // Check if ONLY historical seasons are active
            const isOnlyHistoricalActive = activeSeasons.length > 0 && activeSeasons.every(s => HISTORICAL_SEASONS.includes(s));

            if (currentView === 'stats') {
                const statsControls = document.getElementById('stats-controls');
                if (statsControls) statsControls.classList.remove('hidden');
                if(is2526Active) {
                    const updateAlert = document.getElementById('update-alert-2526');
                    if (updateAlert) updateAlert.classList.remove('hidden');
                }
                result = processStatsData();
                if(result.length > 0) {
                    const maxMatches = Math.max(...result.map(r => r.matches));
                    const sliderDesktop = document.getElementById('minMatches');
                    const sliderMobile = document.getElementById('minMatches_mobile');
                    if (sliderDesktop) sliderDesktop.max = maxMatches;
                    if (sliderMobile) sliderMobile.max = maxMatches;

                    if(sliderDesktop && parseInt(sliderDesktop.value) > maxMatches) {
                        sliderDesktop.value = 0;
                        if (sliderMobile) sliderMobile.value = 0;
                        updateMinMatches(0); minMatchesFilter = 0;
                        const minMatchesValue = document.getElementById('minMatchesValue');
                        if (minMatchesValue) minMatchesValue.innerText = 0;
                        const minMatchesValueMobile = document.getElementById('minMatchesValue_mobile');
                        if (minMatchesValueMobile) minMatchesValueMobile.innerText = 0;
                    }
                }
                result = result.filter(r => r.matches >= minMatchesFilter);
                if(hideInactive) result = result.filter(r => !r.isInactive);
            }
            else if (currentView === 'playingTime') {
                if (playingTimeTitle) playingTimeTitle.classList.remove('hidden');
                if(is2526Active) {
                    const disclaimer = document.getElementById('disclaimer-2526');
                    if (disclaimer) disclaimer.classList.remove('hidden');
                }
                
                result = processPlayingTimeViewData();
            }
            else if (currentView === 'matches') {
                if (matchesTitle) matchesTitle.classList.remove('hidden');
                if(is2526Active) {
                     const disclaimer = document.getElementById('disclaimer-2526');
                     if (disclaimer) disclaimer.classList.remove('hidden');
                     const updateAlert = document.getElementById('update-alert-2526');
                     if (updateAlert) updateAlert.classList.remove('hidden');
                }
                
                result = processMatchesViewData();
            }

            // FIX #5: Placeholder dinamico
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                if (currentView === 'matches') {
                    searchInput.placeholder = 'Squadra...';
                } else {
                    searchInput.placeholder = 'Arbitro...';
                }
            }


            const q = searchInput ? searchInput.value.toLowerCase() : '';
            if(q && result.length > 0) {
                if(currentView === 'matches') result = result.filter(r => r.match.toLowerCase().includes(q));
                else result = result.filter(r => r.name.toLowerCase().includes(q));
            }

            if (result.length > 0) {
                result.sort((a, b) => {
                    let va = a[sortColumn], vb = b[sortColumn];
                    if (typeof va === 'string') return sortDirection === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
                    return sortDirection === 'desc' ? vb - va : va - vb;
                });
            }

            // DECISIONE FINALE VISUALIZZAZIONE
            if (result.length > 0) {
                // Abbiamo dati -> Mostra tabella, nascondi messaggi
                if(table) table.classList.remove('hidden');
                renderTable(result); // Popola la tabella
                updateKPIDashboard(result);
            } else {
                // Non abbiamo dati -> Decidi quale messaggio mostrare
                updateKPIDashboard([]);
                if (isOnlyHistoricalActive) {
                    // Caso: Solo storici attivi e nessun dato -> Mostra "Caricamento storico"
                    if(msgHistorical) msgHistorical.classList.remove('hidden');
                    const historicalMsgTitle = document.getElementById('historical-msg-title');
                    if (historicalMsgTitle) historicalMsgTitle.innerText = `Dati Stagione ${activeSeasons.join(', ')} in fase di caricamento...`;
                } else {
                    // Altri casi (filtri troppo stretti, stagione corrente vuota, ecc) -> "Nessun dato"
                     if(msgEmpty) msgEmpty.classList.remove('hidden');
                }
            }

            updateSeasonButtonsUI();
            
            // FIX #3: Empty insights container instead of rendering cards
            const insightsContainer = document.getElementById('insights-container');
            if (insightsContainer) insightsContainer.innerHTML = '';
        }

        // --- Render Table (UNCHANGED) ---
        function renderTable(data) {
            const thead = document.getElementById('tableHeader');
            const tbody = document.getElementById('tableBody');
            const tfoot = document.getElementById('tableFooter');
            
            if (thead) thead.innerHTML = '';
            if (tbody) tbody.innerHTML = '';
            if (tfoot) tfoot.innerHTML = '';

            // Note: visibility logic moved to aggregateData to fix the bug
            
            const thClass = "p-3 sm:p-4 text-center cursor-pointer hover:bg-slate-800 transition-colors group";
            const tdClass = "p-3 sm:p-4 text-center border-b border-white/5";

            if (currentView === 'stats') {
                if (thead) thead.innerHTML = `<tr>
                    <th class="p-3 sm:p-4 sticky-col-head text-left w-1/3 cursor-pointer" onclick="handleSort('name')">Arbitro</th>
                    <th class="${thClass} text-lime-400 font-bold" onclick="handleSort('matches')" title="Presenze Totali">PRES</th>
                    <th class="${thClass} text-red-300" onclick="handleSort('avgFouls')" title="Media Falli per Partita">FALLI/P</th>
                    <th class="${thClass} text-yellow-400" onclick="handleSort('yellows')" title="Cartellini Gialli Totali">G. TOT</th>
                    <th class="${thClass} text-yellow-600" onclick="handleSort('avgYellows')" title="Media Gialli per Partita">G/P</th>
                    <th class="${thClass} text-red-500" onclick="handleSort('reds')" title="Cartellini Rossi Totali">R. TOT</th>
                    <th class="${thClass} text-red-700" onclick="handleSort('avgReds')" title="Media Rossi per Partita">R/P</th>
                    <th class="${thClass} text-slate-300" onclick="handleSort('avgPens')" title="Rigori per Partita">RIG/P</th>
                </tr>`;

                let totM = 0, totY = 0, totR = 0, totF = 0, totP = 0;
                data.forEach((r, i) => {
                    totM += r.matches; totY += r.yellows; totR += r.reds; totF += r.avgFouls * r.matches; totP += r.avgPens * r.matches;
                    const row = document.createElement('tr');
                    row.className = `animate-fade-in-up ${r.isInactive ? 'opacity-60 grayscale' : ''}`;
                    row.style.animationDelay = `${i * 0.03}s`;
                    row.innerHTML = `
                        <td class="p-3 sm:p-4 sticky-col-body text-left font-sans text-white tracking-wide">${formatRefereeNameHTML(r.name)}</td>
                        <td class="${tdClass} font-bold text-lime-400 text-lg">${r.matches}</td>
                        <td class="${tdClass} font-medium">${r.avgFouls.toFixed(2)}</td>
                        <td class="${tdClass} font-bold text-yellow-400">${r.yellows}</td>
                        <td class="${tdClass} text-yellow-600">${r.avgYellows.toFixed(2)}</td>
                        <td class="${tdClass} font-bold text-red-500">${r.reds}</td>
                        <td class="${tdClass} text-red-700">${r.avgReds.toFixed(2)}</td>
                        <td class="${tdClass} text-slate-400">${r.avgPens.toFixed(2)}</td>
                    `;
                    if (tbody) tbody.appendChild(row);
                });
                if (tfoot) tfoot.innerHTML = `<tr class="uppercase tracking-widest text-[10px] sm:text-xs">
                    <td class="p-4 font-bold sticky-col-body text-left text-xs sm:text-sm font-extrabold text-white">TOTALI/MEDIE</td>
                    <td class="p-4 text-center text-lime-400 font-extrabold text-xs sm:text-sm">${totM}</td>
                    <td class="p-4 text-center font-bold text-white/90 text-xs sm:text-sm">${(totF/totM).toFixed(2)}</td>
                    <td class="p-4 text-center text-yellow-400 font-extrabold text-xs sm:text-sm">${totY}</td>
                    <td class="p-4 text-center text-yellow-600 font-bold text-xs sm:text-sm">${(totY/totM).toFixed(2)}</td>
                    <td class="p-4 text-center text-red-500 font-extrabold text-xs sm:text-sm">${totR}</td>
                    <td class="p-4 text-center text-red-700 font-bold text-xs sm:text-sm">${(totR/totM).toFixed(2)}</td>
                    <td class="p-4 text-center text-slate-400 font-bold text-xs sm:text-sm">${(totP/totM).toFixed(2)}</td>
                </tr>`;

            } else if (currentView === 'playingTime') {
                const showTotalTime = activeSeasons.includes('2025-26') || activeSeasons.includes('2024-25');
                if (thead) thead.innerHTML = `<tr>
                    <th class="p-3 sm:p-4 sticky-col-head text-left w-1/4 cursor-pointer" onclick="handleSort('name')">Arbitro</th>
                    <th class="${thClass} w-24" onclick="handleSort('matches')">Partite</th>
                    <th class="${thClass} text-green-400 text-right pr-6" onclick="handleSort('avgEffSec')" title="Tempo Effettivo Medio">Media T.E.</th>
                    ${showTotalTime ? `<th class="${thClass} text-blue-400 text-right pr-6" onclick="handleSort('avgTotSec')" title="Tempo Totale Medio">Media T. Tot</th>` : ''}
                    <th class="p-3 w-10"></th>
                </tr>`;

                // NEW: Accumulatori per il footer "TOTALI/MEDIE"
                let grandTotMatches = 0;
                let grandTotEffSec = 0;
                let grandCountEff = 0;
                let grandTotTotSec = 0;
                let grandCountTot = 0;

                data.forEach((r, i) => {
                    grandTotMatches += r.matches;
                    // Somma delle medie moltiplicate per il numero di partite valide per recuperare il totale grezzo
                    grandTotEffSec += r.totalEffectiveSec; 
                    grandCountEff += r.validEffMatches;
                    grandTotTotSec += r.totalTotalSec;
                    grandCountTot += r.validTotMatches;

                    const tr = document.createElement('tr');
                    tr.className = "cursor-pointer group animate-fade-in-up border-b border-white/5";
                    tr.style.animationDelay = `${i * 0.03}s`;
                    tr.onclick = () => toggleDetails(i);
                    
                    tr.innerHTML = `
                        <td class="p-3 sm:p-4 sticky-col-body text-left font-sans text-white tracking-wide">${formatRefereeNameHTML(r.name)}</td>
                        <td class="${tdClass} text-slate-300 font-bold">${r.matches}</td>
                        <td class="${tdClass} text-right font-mono font-medium text-green-400 pr-6">${formatSecondsToTime(r.avgEffSec)}</td>
                        ${showTotalTime ? `<td class="${tdClass} text-right font-mono text-blue-400 pr-6">${formatSecondsToTime(r.avgTotSec)}</td>` : ''}
                        <td class="${tdClass} text-slate-500 group-hover:text-white"><i class="fa-solid fa-chevron-down text-xs transition-transform" id="icon-${i}"></i></td>
                    `;
                    if (tbody) tbody.appendChild(tr);

                    const detailsTr = document.createElement('tr');
                    detailsTr.id = `details-${i}`;
                    detailsTr.className = "details-row";
                    const colSpan = showTotalTime ? 5 : 4;
                    let matchesHtml = r.matchList.map(m => {
                        const effDisplay = formatSecondsToTime(m.effectiveTimeSec);
                        const totDisplay = formatSecondsToTime(m.totalTimeSec);
                        const effClass = effDisplay === 'ND' ? "text-center text-slate-500" : "text-right text-green-400 font-medium";
                        return `<div class="flex justify-between items-center py-2 border-b border-white/5 last:border-0 text-xs hover:bg-white/5 px-2 rounded">
                            <span class="text-white w-1/3 font-bold truncate pr-2">${m.match}</span>
                            <span class="text-slate-500 font-mono w-16">${m.season}</span>
                            <span class="${effClass} font-mono w-20">${effDisplay === 'ND' ? 'ND' : effDisplay}</span>
                            <span class="text-right text-blue-400 font-mono w-20">${totDisplay === 'ND' ? 'ND' : totDisplay}</span>
                        </div>`
                    }).join('');
                    detailsTr.innerHTML = `<td colspan="${colSpan}" class="p-0"><div class="bg-slate-950/80 p-4 shadow-inner border-y border-white/5">
                        <h4 class="text-[10px] uppercase font-bold text-slate-500 mb-3 tracking-widest flex items-center gap-2"><i class="fa-solid fa-list-ul"></i> Dettaglio Partite</h4>
                        ${matchesHtml || '<span class="text-slate-600 text-xs italic">Nessun dettaglio.</span>'}
                    </div></td>`;
                    if (tbody) tbody.appendChild(detailsTr);
                });

                // NEW: Costruzione Footer Playing Time
                const globalAvgEff = grandCountEff ? grandTotEffSec / grandCountEff : 0;
                const globalAvgTot = grandCountTot ? grandTotTotSec / grandCountTot : 0;

                if (tfoot) {
                    tfoot.innerHTML = `<tr class="uppercase tracking-widest text-[10px] sm:text-xs">
                        <td class="p-4 font-bold sticky-col-body text-left text-xs sm:text-sm font-extrabold text-white">TOTALI/MEDIE</td>
                        <td class="p-4 text-center text-lime-400 font-extrabold text-xs sm:text-sm">${grandTotMatches}</td>
                        <td class="p-4 text-right text-green-400 pr-6 font-bold text-xs sm:text-sm">${formatSecondsToTime(globalAvgEff)}</td>
                        ${showTotalTime ? `<td class="p-4 text-right text-blue-400 pr-6 font-bold text-xs sm:text-sm">${formatSecondsToTime(globalAvgTot)}</td>` : ''}
                        <td></td>
                    </tr>`;
                }

            } else { // Matches
                if (thead) thead.innerHTML = `<tr>
                    <th class="p-3 sm:p-4 sticky-col-head text-left cursor-pointer" onclick="handleSort('match')">Partita</th>
                    <th class="${thClass}" onclick="handleSort('season')">Stagione</th>
                    <th class="${thClass} text-right text-blue-400" onclick="handleSort('totalTimeSec')">T. Totale</th>
                    <th class="${thClass} text-right text-green-400" onclick="handleSort('effectiveTimeSec')">T. Effettivo</th>
                    <th class="${thClass}" onclick="handleSort('ratio')">%</th>
                    <th class="${thClass} text-red-500" onclick="handleSort('fouls')">Falli</th>
                </tr>`;

                const maxFouls = data.length > 0 ? Math.max(...data.map(d => d.fouls)) : 1;

                // NEW: Accumulatori per footer
                let mTotTime = 0, mCountTot = 0;
                let mEffTime = 0, mCountEff = 0;
                let mRatio = 0, mCountRatio = 0;
                let mFouls = 0;

                data.forEach((r,i) => {
                    const displayRatio = isNaN(r.ratio) ? "ND" : `${r.ratio}%`;
                    const foulsPerc = Math.min((r.fouls / maxFouls) * 100, 100);

                    // Accumulo dati per medie
                    if(!isNaN(r.totalTimeSec)) { mTotTime += r.totalTimeSec; mCountTot++; }
                    if(!isNaN(r.effectiveTimeSec)) { mEffTime += r.effectiveTimeSec; mCountEff++; }
                    if(!isNaN(r.ratio)) { mRatio += r.ratio; mCountRatio++; }
                    mFouls += r.fouls;

                    const tr = document.createElement('tr');
                    tr.className = "animate-fade-in-up border-b border-white/5";
                    tr.style.animationDelay = `${i * 0.02}s`;
                    tr.innerHTML = `
                        <td class="p-3 sm:p-4 sticky-col-body font-sans font-bold text-white uppercase tracking-wide truncate max-w-[150px] sm:max-w-none text-left">${r.match}</td>
                        <td class="${tdClass} text-slate-500 font-mono">${r.season}</td>
                        <td class="${tdClass} text-right font-mono text-blue-400">${formatSecondsToTime(r.totalTimeSec)}</td>
                        <td class="${tdClass} text-right font-mono text-green-400 font-medium">${formatSecondsToTime(r.effectiveTimeSec)}</td>
                        <td class="${tdClass} text-slate-400 font-mono">${displayRatio}</td>
                        <td class="${tdClass} font-bold text-red-500">
                            ${r.fouls}
                            <div class="mini-bar-bg"><div class="mini-bar-fill danger" style="width:${foulsPerc}%"></div></div>
                        </td>
                    `;
                    if (tbody) tbody.appendChild(tr);
                });

                // NEW: Costruzione Footer Matches
                const avgTotDisplay = mCountTot ? formatSecondsToTime(mTotTime / mCountTot) : "ND";
                const avgEffDisplay = mCountEff ? formatSecondsToTime(mEffTime / mCountEff) : "ND";
                const avgRatioDisplay = mCountRatio ? (mRatio / mCountRatio).toFixed(1) + '%' : "ND";
                const avgFoulsDisplay = data.length ? (mFouls / data.length).toFixed(2) : "0.00";

                if (tfoot) {
                    tfoot.innerHTML = `<tr class="uppercase tracking-widest text-[10px] sm:text-xs">
                        <td class="p-4 font-bold sticky-col-body text-left text-xs sm:text-sm font-extrabold text-white">TOTALI/MEDIE</td>
                        <td></td>
                        <td class="p-4 text-right text-blue-400 font-bold text-xs sm:text-sm">${avgTotDisplay}</td>
                        <td class="p-4 text-right text-green-400 font-bold text-xs sm:text-sm">${avgEffDisplay}</td>
                        <td class="p-4 text-center text-slate-400 font-bold text-xs sm:text-sm">${avgRatioDisplay}</td>
                        <td class="p-4 text-center text-red-500 font-bold text-xs sm:text-sm">${avgFoulsDisplay}</td>
                    </tr>`;
                }
            }
        }

        // --- FIX: Context-Aware KPI Dashboard ---
        function updateKPIDashboard(data) {
            // FIX: Retrieve elements with null check
            const l1 = document.getElementById('kpi-label-1'); const v1 = document.getElementById('kpi-value-1');
            const l2 = document.getElementById('kpi-label-2'); const v2 = document.getElementById('kpi-value-2');
            const l3 = document.getElementById('kpi-label-3'); const v3 = document.getElementById('kpi-value-3');
            const l4 = document.getElementById('kpi-label-4'); const v4 = document.getElementById('kpi-value-4');
            
            // Check if any KPI element exists (only rendered on desktop)
            if (!l1 || !v1) return;

            const count = data.length;

            // Utility per resettare classi
            const resetClasses = (v, color, isMono=true) => {
                v.className = `text-2xl font-mono font-bold mt-1 ${isMono ? 'font-mono' : 'font-sans'} text-${color} ${count === 0 ? 'text-slate-600' : ''}`;
            };
            const resetLabelClasses = (l) => {
                 l.className = "text-[9px] uppercase tracking-widest text-slate-500 font-bold";
            }
            
            // Esecuzione
            if (currentView === 'stats') {
                // STATS VIEW: Arbitri Tot, Falli/P, Gialli/P, Rossi/P
                let totalF = 0, totalMatches = 0, totalY = 0, totalR = 0;
                data.forEach(r => {
                    totalF += (r.avgFouls * r.matches);
                    totalMatches += r.matches;
                    totalY += r.yellows;
                    totalR += r.reds;
                });
                const avgFoulsPerMatch = totalMatches ? (totalF / totalMatches).toFixed(2) : 0;
                const avgYellowsPerMatch = totalMatches ? (totalY / totalMatches).toFixed(2) : 0;
                const avgRedsPerMatch = totalMatches ? (totalR / totalMatches).toFixed(3) : 0;
                
                resetLabelClasses(l1); resetLabelClasses(l2); resetLabelClasses(l3); resetLabelClasses(l4);
                
                l1.innerText = "Arbitri Tot."; v1.innerText = count; resetClasses(v1, 'white');
                l2.innerText = "Falli / P"; v2.innerText = avgFoulsPerMatch; resetClasses(v2, 'red-400');
                l3.innerText = "Gialli / P"; v3.innerText = avgYellowsPerMatch; resetClasses(v3, 'yellow-500');
                l4.innerText = "Rossi / P"; v4.innerText = avgRedsPerMatch; resetClasses(v4, 'red-700');

            } else if (currentView === 'playingTime') {
                // TIME VIEW: Arbitri Tot, Partite Tot, Media T. Eff, Media T. Tot
                let totEffSec = 0, validEff = 0;
                let totTotSec = 0, validTot = 0;
                data.forEach(r => { 
                    if(r.avgEffSec) { totEffSec += r.avgEffSec; validEff++; }
                    if(r.avgTotSec) { totTotSec += r.avgTotSec; validTot++; }
                });
                const avgEff = validEff ? formatSecondsToTime(totEffSec / validEff) : "ND";
                const avgTot = validTot ? formatSecondsToTime(totTotSec / validTot) : "ND";

                resetLabelClasses(l1); resetLabelClasses(l2); resetLabelClasses(l3); resetLabelClasses(l4);

                l1.innerText = "Arbitri Tot."; v1.innerText = count; resetClasses(v1, 'white');
                l2.innerText = "Partite Tot."; v2.innerText = data.reduce((sum, r) => sum + r.matches, 0); resetClasses(v2, 'lime-400');
                l3.innerText = "Media T. Eff"; v3.innerText = avgEff; resetClasses(v3, 'green-400');
                l4.innerText = "Media T. Tot"; v4.innerText = avgTot; resetClasses(v4, 'blue-400');

            } else { 
                // MATCHES VIEW: Partite Vis, Media Falli, Media T.E., Media T.Tot
                let totF = 0;
                let totEff = 0, cntEff = 0;
                let totTot = 0, cntTot = 0;

                data.forEach(r => { 
                    totF += r.fouls;
                    if(!isNaN(r.effectiveTimeSec)) { totEff += r.effectiveTimeSec; cntEff++; }
                    if(!isNaN(r.totalTimeSec)) { totTot += r.totalTimeSec; cntTot++; }
                });
                const avgFouls = count ? (totF / count).toFixed(1) : 0;
                const avgEff = cntEff ? formatSecondsToTime(totEff / cntEff) : "ND";
                const avgTot = cntTot ? formatSecondsToTime(totTot / cntTot) : "ND";

                resetLabelClasses(l1); resetLabelClasses(l2); resetLabelClasses(l3); resetLabelClasses(l4);

                l1.innerText = "Partite Vis."; v1.innerText = count; resetClasses(v1, 'white');
                l2.innerText = "Media Falli"; v2.innerText = avgFouls; resetClasses(v2, 'red-400');
                l3.innerText = "Media T.E."; v3.innerText = avgEff; resetClasses(v3, 'green-400');
                l4.innerText = "Media T.Tot"; v4.innerText = avgTot; resetClasses(v4, 'blue-400');
            }
        }

        function toggleDetails(index) {
            const row = document.getElementById(`details-${index}`);
            const icon = document.getElementById(`icon-${index}`);
            if(row.classList.contains('open')) { row.classList.remove('open'); icon.style.transform = 'rotate(0deg)'; } 
            else { row.classList.add('open'); icon.style.transform = 'rotate(180deg)'; }
        }

        function handleSort(col) {
            if (sortColumn === col) sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            else { sortColumn = col; sortDirection = 'desc'; }
            aggregateData();
        }

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.nav-switcher-btn').forEach(b => {
                 b.classList.remove('active');
                 b.classList.remove('bg-transparent');
            });
            
            // FIX #4: Reset Search Input and Filter
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.value = '';
            
            if(view === 'stats') { document.getElementById('nav-stats').classList.add('active'); sortColumn = 'matches'; sortDirection = 'desc'; }
            if(view === 'playingTime') { document.getElementById('nav-time').classList.add('active'); sortColumn = 'avgEffSec'; sortDirection = 'desc'; }
            if(view === 'matches') { document.getElementById('nav-matches').classList.add('active'); sortColumn = 'match'; sortDirection = 'asc'; }
            
            // Forza il ripristino delle classi 'bg-transparent' per i bottoni NON attivi
            document.querySelectorAll('.nav-switcher-btn').forEach(b => {
                if (!b.classList.contains('active')) {
                    b.classList.add('bg-transparent');
                    b.classList.remove('shadow-none'); // Opzionale, ma mantiene lo stile coerente
                }
            });

            aggregateData(); // Aggrega i dati con il filtro di ricerca azzerato
        }

        function toggleSeason(s) {
            // FIX #6: Permetti il toggle se STATS è la view O se la stagione è 25/26 o 24/25
            
            if(window.innerWidth < 1024) { /* Prevent auto close */ }
            if(activeSeasons.includes(s)) activeSeasons = activeSeasons.filter(x => x !== s);
            else activeSeasons.push(s);
            updateSeasonButtonsUI();
            aggregateData();
        }

        function toggleAllSeasons() {
            // Se STATS, considera tutte le stagioni. Altrimenti solo le 25/26 e 24/25.
            let all = ['2025-26', '2024-25'];
            if(currentView === 'stats') {
                all = ['2025-26', '2024-25', '2023-24', '2022-23', '2021-22', '2020-21'];
            }
            activeSeasons = activeSeasons.length === all.length ? [] : [...all];
            updateSeasonButtonsUI();
            aggregateData();
        }

        function toggleSeasonDropdown() {
            if (window.innerWidth >= 1024) return;
            const content = document.getElementById('season-dropdown-content');
            const icon = document.getElementById('season-toggle-icon');
            if (!content || !icon) return; // Safety check
            isSeasonDropdownOpen = !isSeasonDropdownOpen;
            if (isSeasonDropdownOpen) { content.classList.add('open'); icon.style.transform = 'rotate(180deg)'; } 
            else { content.classList.remove('open'); icon.style.transform = 'rotate(0deg)'; }
        }

        // FIX #6 & #1: Aggiornamento UI Pulsanti Stagione
        function updateSeasonButtonsUI() {
            const allSeasons = ['2025-26', '2024-25', '2023-24', '2022-23', '2021-22', '2020-21'];
            
            allSeasons.forEach(s => {
                const btn = document.getElementById(`btn-${s}`);
                
                if (!btn) return; // safety check
                
                const labelComingSoon = btn.querySelector('.coming-soon-label');
                const isHistorical = HISTORICAL_SEASONS.includes(s);

                // 1. Logica Etichetta "PRESTO"
                if (isHistorical && currentView !== 'stats') {
                     if (labelComingSoon) labelComingSoon.classList.remove('hidden');
                } else {
                     if (labelComingSoon) labelComingSoon.classList.add('hidden');
                }
                
                // 2. Stato Attivo/Non Attivo (Checkmark)
                const icon = btn.querySelector('.check-icon');
                if (icon) {
                    if(activeSeasons.includes(s)) { btn.classList.add('active'); icon.classList.remove('opacity-0'); } 
                    else { btn.classList.remove('active'); icon.classList.add('opacity-0'); }
                }
            });
            
            // Ripristino del corretto stato active/bg-transparent per la nav bar
            document.querySelectorAll('.nav-switcher-btn').forEach(b => {
                if (!b.classList.contains('active')) {
                    b.classList.add('bg-transparent');
                }
            });
        }

        function updateMinMatches(val) {
            minMatchesFilter = parseInt(val);
            const minMatchesValue = document.getElementById('minMatchesValue');
            if (minMatchesValue) minMatchesValue.innerText = val;
            const mobileVal = document.getElementById('minMatchesValue_mobile');
            if(mobileVal) mobileVal.innerText = val;
            const sliderD = document.getElementById('minMatches');
            const sliderM = document.getElementById('minMatches_mobile');
            if(sliderD) sliderD.value = val;
            if(sliderM) sliderM.value = val;
            aggregateData();
        }

        function toggleInactiveRefs() { 
            const toggle = document.getElementById('toggleInactive');
            if (toggle) hideInactive = toggle.checked; 
            aggregateData(); 
        }
        function handleSearch() { aggregateData(); }

        // FIX #3: Removed renderStatsInsights and renderMatchesInsights calls usage, left empty functions
        function renderStatsInsights(data) {}
        function renderMatchesInsights(data) {}

        function toggleDesignationsModal(shouldOpen) {
            const modal = document.getElementById('designations-modal');
            if (!modal) return; // Safety check
            if (shouldOpen) { modal.classList.add('open'); document.body.style.overflow = 'hidden'; } 
            else { modal.classList.remove('open'); document.body.style.overflow = ''; }
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Scroll Event Listener
        window.addEventListener('scroll', () => {
            const btn = document.getElementById('scroll-to-top');
            if (window.scrollY > 300) btn.classList.add('visible');
            else btn.classList.remove('visible');
        });

        window.onload = function() {
            updateSeasonButtonsUI();
            aggregateData();
            if (window.innerWidth < 1024) {
                const content = document.getElementById('season-dropdown-content');
                const icon = document.getElementById('season-toggle-icon');
                if (content && icon) {
                    content.classList.remove('open');
                    icon.style.transform = 'rotate(0deg)';
                    isSeasonDropdownOpen = false;
                }
            }
        };
    </script>
</body>
</html>
